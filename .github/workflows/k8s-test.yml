name: Kubernetes Integration Test

on:
  push:
    branches: [ "main", "experiment/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  k8s-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install RAR tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unrar rar || true
          # If rar is not available (non-free), we might need another way to create testing rar.
          # Ubuntu repo usually has 'rar' package in multiverse.

      - name: Create Test RAR
        run: |
          # Create a dummy file
          echo "secret content" > secret.txt
          # Try to create RAR file with password "1234"
          # If 'rar' command fails (not installed), this step will fail, which is good warning.
          # Using -p1234 to set password
          # If rar is missing, we can try using python rarfile if it supported write, but it doesn't support password write easily without tools.
          # Check if rar is installed
          if ! command -v rar &> /dev/null; then
              echo "rar could not be installed. Skipping test generation."
              # Fallback: Create a fake file and mock the validation in code? No, integration test should be real.
              # We will try to download a pre-made rar or just fail.
              exit 1
          fi
          rar a -p1234 -hp1234 test_1234.rar secret.txt

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true # Load into local docker daemon
          tags: rapidrar:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create Kind Cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: rapidrar-cluster

      - name: Install NGINX Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          sleep 15
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=90s

      - name: Load Image into Kind
        run: |
          kind load docker-image rapidrar:test --name rapidrar-cluster

      - name: Deploy RapidRAR
        run: |
          # Replace placeholder SHA with local tag
          sed -i 's|ghcr.io/alittlecrocodile/rapidrar:${GITHUB_SHA}|rapidrar:test|g' k8s/rapidrar-daemonset.yaml
          
          kubectl apply -f k8s/rapidrar-daemonset.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml
          
          # Wait for rollout
          kubectl rollout status daemonset/rapidrar-daemonset --timeout=120s

      - name: Setup Port Forwarding
        run: |
          # Forward host port 8080 to service 80
          kubectl port-forward service/rapidrar-service 8080:80 &
          # Wait for forwarder
          sleep 5

      - name: Run Integration Test
        env:
          SERVICE_URL: http://localhost:8080
        run: |
          pip install requests
          python test_integration.py
